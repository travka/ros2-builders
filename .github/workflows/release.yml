name: Release

on:
  push:
    tags: [ 'v*.*.*' ]

permissions:
  contents: write
  packages: write
  id-token: write

env:
  IMAGE_NAME: travka/ros2-humble

jobs:
  create-release:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      upload_url: ${{ steps.release.outputs.upload_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Extract version
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if [ -f CHANGELOG.md ]; then
            echo "changelog=$(sed -n "/^## \\[${VERSION}\\]/,/^## /p" CHANGELOG.md | head -n -1)" >> $GITHUB_OUTPUT
          else
            echo "changelog=Release ${VERSION}" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        id: release
        uses: softprops/action-gh-release@v2
        with:
          body: |
            ## ROS2 Builders v${{ steps.version.outputs.version }}

            ### Changes
            ${{ steps.changelog.outputs.changelog }}

            ### Installation

            #### Docker
            ```bash
            docker pull travka/ros2-humble:v${{ steps.version.outputs.version }}
            docker pull travka/ros2-humble:latest
            ```

            #### macOS Homebrew
            ```bash
            brew tap travka/ros2
            brew install ros2-humble
            ```

            ### What's New
            - Multi-architecture Docker images (ARM64/AMD64)
            - Homebrew formula for macOS
            - Automated security scanning
            - SBOM generation for all builds
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-docker-release:
    runs-on: ubuntu-latest
    needs: create-release
    permissions:
      contents: read
      packages: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-release-${{ needs.create-release.outputs.version }}
          restore-keys: |
            ${{ runner.os }}-buildx-
            ${{ runner.os }}-buildx

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push release images
        uses: docker/build-push-action@v5
        with:
          context: ./builders/docker
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:v${{ needs.create-release.outputs.version }}
            ${{ env.IMAGE_NAME }}:v${{ steps.version.outputs.version }}
            ${{ env.IMAGE_NAME }}:latest
          labels: |
            org.opencontainers.image.version=${{ needs.create-release.outputs.version }}
            org.opencontainers.image.revision=${{ github.sha }}
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}

      - name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

      - name: Generate and upload SBOM
        uses: anchore/sbom-action@v0
        with:
          image: ${{ env.IMAGE_NAME }}:v${{ needs.create-release.outputs.version }}
          format: spdx-json
          output-file: sbom-docker-${{ needs.create-release.outputs.version }}.json

      - name: Upload SBOM to release
        uses: softprops/action-gh-release@v2
        with:
          files: sbom-docker-${{ needs.create-release.outputs.version }}.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-homebrew:
    runs-on: ubuntu-latest
    needs: create-release

    steps:
      - name: Checkout tap repository
        uses: actions/checkout@v6
        with:
          repository: travka/homebrew-ros2
          token: ${{ secrets.PAT_TOKEN }}
          path: tap-repo

      - name: Copy formula
        run: |
          cp builders/macos/ros2-humble.rb tap-repo/Formula/ros2-humble.rb

      - name: Update formula version
        working-directory: tap-repo
        run: |
          VERSION="${{ needs.create-release.outputs.version }}"
          sed -i.bak "s/url \".*\"/url \"https:\/\/github.com\/ros2\/ros2\/archive\/refs\/tags\/humble-20241206.tar.gz\"/g" Formula/ros2-humble.rb
          sed -i.bak2 "s/version \".*\"/version \"${VERSION}\"/g" Formula/ros2-humble.rb
          rm Formula/ros2-humble.rb.bak Formula/ros2-humble.rb.bak2

      - name: Commit and push
        working-directory: tap-repo
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/ros2-humble.rb
          git commit -m "Update ros2-humble to v${{ needs.create-release.outputs.version }}"
          git push origin main
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}

  create-bottles:
    runs-on: ${{ matrix.os }}
    needs: [create-release, build-docker-release]
    strategy:
      matrix:
        os: [macos-13, macos-14]
        include:
          - os: macos-13
            bottle_tag: ventura
          - os: macos-14
            bottle_tag: sonoma

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install bottle dependencies
        run: |
          brew update
          brew install --build-from-source ./builders/macos/ros2-humble.rb --debug --verbose

      - name: Create bottle
        run: |
          cd $(brew --repo)
          brew bottle --no-rebuild --root-url=https://ghcr.io/v2/travka/homebrew-ros2 ./builders/macos/ros2-humble.rb

      - name: Upload bottles
        uses: actions/upload-artifact@v4
        with:
          name: bottle-${{ matrix.bottle_tag }}
          path: "*.bottle.tar.gz"
          retention-days: 30

  notify:
    runs-on: ubuntu-latest
    needs: [create-release, build-docker-release, update-homebrew]
    if: always()

    steps:
      - name: Release Summary
        run: |
          echo "## Release v${{ needs.create-release.outputs.version }} Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [x] GitHub Release created" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Docker images pushed to Docker Hub" >> $GITHUB_STEP_SUMMARY
          echo "- [x] SBOM generated and attached" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Homebrew formula updated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Installation Instructions" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Docker" >> $GITHUB_STEP_SUMMARY
          echo "docker pull travka/ros2-humble:v${{ needs.create-release.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# macOS" >> $GITHUB_STEP_SUMMARY
          echo "brew tap travka/ros2" >> $GITHUB_STEP_SUMMARY
          echo "brew install ros2-humble" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
